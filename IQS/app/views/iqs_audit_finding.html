<div class="app-shell">

    <div class="main-layout">
     

        <div class="content-area">
            <div id="scroll_content" class="scroll-flex" dx-scroll-view="scroll_content">

                <div class="page-header">
                    <div class="page-title-block">
                        <div class="page-title">
                            Audit Finding – {{ item.auditNo }}
                            <span class="page-title-pill">Internal audit</span>
                        </div>
                        <div class="page-subtitle">
                            Finding details, CAP, auditor acceptance, follow-ups, verification, and closure (VRH-CMS-01 flow).
                        </div>
                    </div>

                    <div class="page-actions">
                        <div dx-button="btn_back" class="btn btn-ghost">
                            <span class="icon">←</span>
                            Back
                        </div>
                        <div dx-button="btn_save" class="btn btn-primary">
                            <span class="icon">＋</span>
                            Save
                        </div>
                    </div>
                </div>

                <!-- FINDING DETAILS -->
                <div class="card">
                    <div class="page-subtitle" style="margin-bottom:8px;">Finding details</div>

                    <div class="form-grid">
                        <div class="form-group full">
                            <label><span class="field-name">Finding title</span></label>
                            <div class="input" dx-text-box="txt_title" dx-validator="{validationGroup:'auditsave',  validationRules: [{ type: 'required' }]}"></div>
                        </div>

                        <div class="form-group">
                            <label><span class="field-name">Finding code</span></label>
                            <div class="input" dx-text-box="txt_code"></div>
                        </div>

                        <div class="form-group">
                            <label><span class="field-name">Finding level</span></label>
                            <div class="input" dx-text-box="txt_level"></div>
                        </div>

                        <div class="form-group">
                            <label><span class="field-name">Lead auditor</span></label>
                            <div dx-select-box="sb_auditors"></div>
                        </div>

                        <div class="form-group">
                            <label><span class="field-name">Report sent date</span></label>
                            <div class="input" dx-date-box="dt_sent_report_date"></div>
                        </div>

                        <div class="form-group">
                            <label><span class="field-name">Closure due date</span></label>
                            <div class="input" dx-date-box="dt_closure_deadline"></div>
                        </div>

                        <div class="form-group">
                            <label><span class="field-name">Auditor sign-off date</span></label>
                            <div class="input" dx-date-box="dt_closure_auditor_date"></div>
                        </div>

                        <div class="form-group full">
                            <label><span class="field-name">Reference / standard no.</span></label>
                            <div class="input" dx-text-box="txt_standard_title"></div>
                        </div>

                        <div class="form-group full">
                            <label><span class="field-name">Description of standard</span></label>
                            <div class="input" dx-text-area="txt_standard_description"></div>
                        </div>

                        <div class="form-group full">
                            <label><span class="field-name">Non-compliance description</span></label>
                            <div class="input" dx-text-area="txt_none_compliance_description"></div>
                        </div>

                        <div></div>
                    </div>

                    <div class="section-divider"></div>

                    <!-- CORRECTIVE ACTIONS & CAP FLOW -->
                    <div class="section-head">
                        <div class="page-subtitle">Corrective actions &amp; CAP workflow</div>
                        <!-- اگر دکمه add داری -->
                        <!--<div dx-button="btn_action_add" class="btn btn-primary"></div>-->
                    </div>

                    <div ng-repeat="a in actions" class="card action-card">
                        <div class="page-subtitle" style="margin-bottom:6px;">
                            Corrective action #{{$index + 1}}
                            <span class="tag" style="margin-left:8px;">CAP</span>
                        </div>

                        <div class="form-grid">
                            <!-- CAP (filled by Auditee) -->
                            <div class="form-group full">
                                <div class="followup-box">
                                    <div class="page-subtitle" style="margin-bottom:8px;">Corrective action plan (filled by auditee)</div>

                                    <div class="form-grid" style="margin-top:6px;">
                                        <div class="form-group">
                                            <label><span class="field-name">Action title</span></label>
                                            <input type="text" ng-model="a.action_title" class="form-control" />
                                        </div>

                                        <div class="form-group">
                                            <label><span class="field-name">Action code</span></label>
                                            <input type="text" ng-model="a.code" class="form-control" />
                                        </div>

                                        <div class="form-group full">
                                            <label><span class="field-name">Root cause analysis (RCA)</span></label>
                                            <input type="text" ng-model="a.root_cause_analysis_desc" class="form-control" />
                                        </div>

                                        <div class="form-group full">
                                            <label><span class="field-name">Corrective action plan</span></label>
                                            <input type="text" ng-model="a.corrective_action_plan" class="form-control" />
                                        </div>

                                        <div class="form-group">
                                            <label><span class="field-name">Requested implementation date</span></label>
                                            <input type="text" ng-model="a.request_implementation_date" class="form-control" />
                                        </div>

                                        <div class="form-group">
                                            <label><span class="field-name">Responsible manager</span></label>
                                            <input type="text" ng-model="a.responsible_manager_name" class="form-control" />
                                        </div>

                                        <div class="form-group">
                                            <label><span class="field-name">Manager sign-off date</span></label>
                                            <input type="text" ng-model="a.sign_date" class="form-control" />
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- CAP ACCEPTANCE (Auditor) -->
                            <div class="form-group full">
                                <div class="followup-box">
                                    <div class="page-subtitle" style="margin-bottom:8px;">CAP acceptance (auditor)</div>

                                    <div class="followup-grid">
                                        <div class="form-group">
                                            <label><span class="field-name">CAP accepted?</span></label>
                                            <select ng-model="a.cap_accepted" class="form-control">
                                                <option value="">—</option>
                                                <option value="true">Yes</option>
                                                <option value="false">No</option>
                                            </select>
                                        </div>

                                        <div class="form-group">
                                            <label><span class="field-name">CAP acceptance date</span></label>
                                            <input type="text" ng-model="a.cap_acceptance_date" class="form-control" />
                                        </div>

                                        <div class="form-group">
                                            <label><span class="field-name">Auditor comment</span></label>
                                            <input type="text" ng-model="a.cap_acceptance_comment" class="form-control" />
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- FOLLOW-UP I -->
                            <div class="form-group full">
                                <div class="followup-box">
                                    <div class="page-subtitle" style="margin-bottom:8px;">Effectiveness review (1)</div>

                                    <div class="followup-grid">
                                        <div class="form-group">
                                            <label><span class="field-name">Follow-up date</span></label>
                                            <input type="text" ng-model="a.follow_up1_date" class="form-control" />
                                        </div>

                                        <div class="form-group">
                                            <label><span class="field-name">Implementation approved?</span></label>
                                            <select ng-model="a.follow_up1_implementation_approved" class="form-control">
                                                <option value="">—</option>
                                                <option value="true">Yes</option>
                                                <option value="false">No</option>
                                            </select>
                                        </div>

                                        <div class="form-group">
                                            <label><span class="field-name">Extended due date</span></label>
                                            <input type="text" ng-model="a.follow_up1_extended_deadline_date" class="form-control" />
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- FOLLOW-UP II -->
                            <div class="form-group full">
                                <div class="followup-box">
                                    <div class="page-subtitle" style="margin-bottom:8px;">Effectiveness review (2)</div>

                                    <div class="followup-grid">
                                        <div class="form-group">
                                            <label><span class="field-name">Follow-up date</span></label>
                                            <input type="text" ng-model="a.follow_up2_date" class="form-control" />
                                        </div>

                                        <div class="form-group">
                                            <label><span class="field-name">Auditor satisfied?</span></label>
                                            <select ng-model="a.follow_up2_effective" class="form-control">
                                                <option value="">—</option>
                                                <option value="true">Yes</option>
                                                <option value="false">No</option>
                                            </select>
                                        </div>

                                        <div class="form-group">
                                            <label><span class="field-name">MRB review date</span></label>
                                            <input type="text" ng-model="a.follow_up2_mrb_review_date" class="form-control" />
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>

                    <div class="section-divider"></div>

                    <!-- VERIFICATION & CLOSURE (Finding-level, as in the form) -->
                    <div class="page-subtitle" style="margin-bottom:8px;">Verification &amp; closure</div>

                    <div class="form-grid">
                        <div class="form-group full">
                            <div class="followup-box">
                                <div class="page-subtitle" style="margin-bottom:8px;">Verified by Compliance Monitoring &amp; Safety Manager</div>

                                <div class="followup-grid">
                                    <div class="form-group">
                                        <label><span class="field-name">Verified by</span></label>
                                        <input type="text" ng-model="item.verified_by_name" class="form-control" />
                                    </div>

                                    <div class="form-group">
                                        <label><span class="field-name">Verification date</span></label>
                                        <input type="text" ng-model="item.verified_date" class="form-control" />
                                    </div>

                                    <div class="form-group">
                                        <label><span class="field-name">Signature / note</span></label>
                                        <input type="text" ng-model="item.verified_signature_note" class="form-control" />
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group full">
                            <div class="followup-box">
                                <div class="page-subtitle" style="margin-bottom:8px;">Closed by auditor</div>

                                <div class="followup-grid">
                                    <div class="form-group">
                                        <label><span class="field-name">Closure date</span></label>
                                        <input type="text" ng-model="item.closure_date" class="form-control" />
                                    </div>

                                    <div class="form-group">
                                        <label><span class="field-name">Auditor name</span></label>
                                        <input type="text" ng-model="item.closed_by_auditor_name" class="form-control" />
                                    </div>

                                    <div class="form-group">
                                        <label><span class="field-name">Signature / note</span></label>
                                        <input type="text" ng-model="item.closed_by_auditor_signature_note" class="form-control" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="section-divider"></div>

                    <!-- LINKED HAZARDS -->
                    <div class="card" style="background:none; border:none; padding:0;">
                        <div class="page-subtitle" style="margin-bottom:6px;">Linked hazards</div>
                        <p class="hint" style="margin:0 0 6px;">
                            Hazards that are either the subject of the audit or are directly affected by its findings.
                        </p>

                        <table>
                            <thead>
                                <tr>
                                    <th>Hazard code</th>
                                    <th>Title</th>
                                    <th>Risk (initial → residual)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr ng-repeat="h in hazards">
                                    <td>{{ h.code }}</td>
                                    <td>{{ h.title }}</td>
                                    <td>{{ h.initialRisk }} → {{ h.residualRisk }}</td>
                                </tr>
                                <tr ng-if="!hazards.length">
                                    <td colspan="3" style="font-size:0.85rem; color:var(--text-muted);">
                                        No hazards linked in this demo.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                </div>

            </div>
        </div>
    </div>
</div>
